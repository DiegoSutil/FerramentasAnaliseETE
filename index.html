<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Idade do Lodo / Eficiência Físico-Química - Braspine Telêmaco Borba</title>
    <!-- Inclui Tailwind CSS via CDN para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Link para a fonte Inter do Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- CSS embutido -->
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Define a fonte Inter para todo o corpo */
        }
        .drop-zone {
            border: 2px dashed #a7f3d0; /* default border */
            background-color: #f0fdf4; /* default background */
            transition: all 0.2s ease-in-out;
        }
        .drop-zone.drag-over {
            border-color: #10b981; /* green-500 */
            background-color: #d1fae5; /* green-100 */
        }
        /* Estilos para ocultar/mostrar seções */
        .hidden-section {
            display: none;
        }
        /* Estilos gerais para inputs e selects para consistência */
        input[type="number"], select {
            /* Increased padding, rounded-lg, added text-gray-800 */
            padding: 12px; /* Increased from p-3 */
            border-radius: 8px; /* Slightly more rounded */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); /* Subtle shadow for depth */
            border: 1px solid #d1d5db; /* A default border color for consistency */
            color: #1f2937; /* Darker text color for inputs */
            width: 100%; /* Ensure full width */
        }

        input[type="number"]::placeholder { /* Style for placeholder text */
            color: #9ca3af; /* A lighter gray for placeholders */
        }

        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #4CAF50; /* Green focus color */
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3), 0 2px 5px rgba(0, 0, 0, 0.15); /* More pronounced shadow on focus */
        }
        label {
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #3C5A3C; /* Darker green for labels */
            margin-bottom: 0.25rem; /* mb-1 */
            display: block; /* Ensure it takes full width */
        }

        /* Classes para indicadores visuais */
        .result-positive {
            color: #10B981; /* green-500 */
        }
        .result-warning {
            color: #F59E0B; /* yellow-500 */
        }
        .result-negative {
            color: #EF4444; /* red-500 */
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-green-100 to-green-300 flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-4xl border border-gray-200">
        <!-- Logo da Braspine -->
        <div class="flex justify-center mb-6">
            <img
                src="https://github.com/DiegoSutil/calculadora-de-lodo/blob/e6af6bb6071166eb8a6dfd01725ad76460471786/images/logo_braspine_horizontal_positivo_cor_rgb.png?raw=true"
                alt="Logo Braspine"
                class="h-12 object-contain rounded-md"
                onerror="this.style.display='none'"
            />
        </div>
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">
            Ferramentas de Análise ETE/ETAR
        </h1>
        <h2 class="text-xl text-center text-gray-600 mb-8">
            <!-- Removido: Braspine Telêmaco Borba -->
        </h2>

        <!-- ID do Usuário -->
        <div id="userIdDisplay" class="text-center text-sm text-gray-500 mb-4 break-words">
            A carregar ID do Utilizador...
        </div>

        <!-- Botões de Navegação -->
        <div class="flex justify-center flex-wrap gap-4 mb-8">
            <button
                id="showSludgeAge"
                class="px-4 py-2 rounded-lg font-bold text-white bg-green-600 hover:bg-green-700 shadow-md transition duration-200 ease-in-out transform hover:scale-105"
            >
                Calculadora Idade do Lodo
            </button>
            <button
                id="showPhysicalChemical"
                class="px-4 py-2 rounded-lg font-bold text-green-800 bg-green-200 hover:bg-green-300 shadow-md transition duration-200 ease-in-out transform hover:scale-105"
            >
                Eficiência Físico-Química
            </button>
            <button
                id="showOrganicLoad"
                class="px-4 py-2 rounded-lg font-bold text-green-800 bg-green-200 hover:bg-green-300 shadow-md transition duration-200 ease-in-out transform hover:scale-105"
            >
                Carga Orgânica (DBO/DQO)
            </button>
            <button
                id="showHowItWorks"
                class="px-4 py-2 rounded-lg font-bold text-green-800 bg-green-200 hover:bg-green-300 shadow-md transition duration-200 ease-in-out transform hover:scale-105"
            >
                Como Funciona
            </button>
        </div>

        <!-- Seção da Calculadora de Idade do Lodo -->
        <div id="sludgeAgeSection" class="">
            <!-- Seção de Importação de CSV -->
            <div id="csvDropZone" class="mb-8 p-6 rounded-lg border border-green-200 drop-zone">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Analisar Dados de Planilha (CSV)</h3>
                <div class="mb-4 text-sm text-yellow-700 bg-yellow-100 border border-yellow-400 rounded-md p-2 text-center">
                    Atenção: Esta funcionalidade está em desenvolvimento e pode não funcionar corretamente.
                </div>
                <label for="csvFile" class="block text-sm font-medium text-gray-700 mb-2">
                    Selecione um ficheiro CSV ou arraste-o aqui:
                </label>
                <input
                    type="file"
                    id="csvFile"
                    accept=".csv"
                    class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-green-50 file:text-green-700
                        hover:file:bg-green-100"
                />
                <button
                    id="analyzeCsvButton"
                    class="mt-4 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out"
                >
                    Analisar CSV e Preencher Campos
                </button>
                <div id="csvAnalysisStatus" class="mt-2 text-sm text-center text-gray-600"></div>
                <div id="csvTableDisplay" class="mt-4 max-h-48 overflow-auto border border-gray-300 rounded-md">
                    <!-- Tabela CSV será exibida aqui -->
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Volume do Tanque de Aeração -->
                <div class="flex flex-col">
                    <label for="aerationTankVolume">
                        Volume do Tanque de Aeração (m³)
                    </label>
                    <input
                        type="number"
                        id="aerationTankVolume"
                        placeholder="Ex: 500"
                        value=""
                    />
                </div>

                <!-- SSV no Tanque de Aeração -->
                <div class="flex flex-col">
                    <label for="aerationTankVSS">
                        SSV no Tanque de Aeração (mg/L)
                    </label>
                    <input
                        type="number"
                        id="aerationTankVSS"
                        placeholder="Ex: 3000"
                        value=""
                    />
                </div>

                <!-- Vazão de Descarte -->
                <div class="flex flex-col">
                    <label for="discardFlowRate">
                        Vazão de Descarte (L/min)
                    </label>
                    <input
                        type="number"
                        id="discardFlowRate"
                        placeholder="Ex: 50"
                        value=""
                    />
                </div>

                <!-- SSV do Lodo Descartado -->
                <div class="flex flex-col">
                    <label for="discardVSS">
                        SSV do Lodo Descartado (mg/L)
                    </label>
                    <input
                        type="number"
                        id="discardVSS"
                        placeholder="Ex: 8000"
                        value=""
                    />
                </div>

                <!-- Vazão do Efluente Final -->
                <div class="flex flex-col">
                    <label for="effluentFlowRate">
                        Vazão do Efluente Final (m³/dia)
                    </label>
                    <input
                        type="number"
                        id="effluentFlowRate"
                        placeholder="Ex: 400"
                        value=""
                    />
                </div>

                <!-- SSV do Efluente Final -->
                <div class="flex flex-col">
                    <label for="effluentVSS">
                        SSV do Efluente Final (mg/L)
                    </label>
                    <input
                        type="number"
                        id="effluentVSS"
                        placeholder="Ex: 20"
                        value=""
                    />
                </div>
            </div>

            <!-- Botão de Cálculo -->
            <button
                id="calculateButton"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105"
            >
                Calcular Idade do Lodo
            </button>
            <button
                id="saveSludgeAgeData"
                class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105"
            >
                Guardar Resultado
            </button>

            <!-- Área de Resultado/Erro -->
            <div id="errorDisplay" class="mt-6 p-3 bg-red-100 border border-red-400 text-red-700 rounded-md text-center hidden"></div>
            <div id="resultDisplay" class="mt-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded-md text-center hidden">
                <h2 class="text-lg font-semibold">Idade do Lodo Calculada:</h2>
                <p id="sludgeAgeResult" class="text-2xl font-bold mt-2"></p>
            </div>

            <div class="mt-8 text-sm text-gray-600 text-center">
                <p>
                    A Idade do Lodo (ISR) é um parâmetro fundamental no controlo de sistemas de lodos ativados,
                    indicando o tempo médio de permanência dos sólidos voláteis no sistema.
                </p>
                <p class="mt-2 font-bold">
                    Fórmula utilizada:
                </p>
                <p class="mt-1">
                    ISR = (Massa de SSV no Tanque de Aeração) / (Massa de SSV Removida Diariamente)
                </p>
                <p class="mt-1 text-xs text-gray-500">
                    Onde:
                </p>
                <p class="mt-1 text-xs text-gray-500">
                    Massa de SSV no Tanque = Volume do Tanque (m³) * SSV do Tanque (mg/L)
                </p>
                <p class="mt-1 text-xs text-gray-500">
                    Massa de SSV Removida = (Vazão de Descarte (L/dia) * SSV Descartado (mg/L)) + (Vazão do Efluente (L/dia) * SSV do Efluente (mg/L))
                </p>
                <p class="mt-2 font-bold text-green-700">
                    Dias ideais para a Idade do Lodo: Geralmente entre 5 e 15 dias.
                </p>
                <p class="mt-1 text-xs text-gray-500">
                    (Este valor pode variar dependendo do tipo de processo e da qualidade da água a ser tratada)
                </p>
                <p class="mt-4 text-xs text-gray-500">
                    Desenvolvido por Diego Machado Sutil
                </p>
            </div>

            <!-- Histórico da Calculadora Idade do Lodo -->
            <div class="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Histórico de Cálculos da Idade do Lodo</h3>
                <div id="sludgeAgeHistory" class="overflow-x-auto">
                    <!-- Histórico será carregado aqui -->
                    <p class="text-center text-gray-500">A carregar histórico...</p>
                </div>
            </div>
        </div>

        <!-- Seção de Eficiência Físico-Química -->
        <div id="physicalChemicalSection" class="hidden-section">
            <h3 class="text-2xl font-bold text-center text-gray-800 mb-8">
                Eficiência Físico-Química
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="flex flex-col">
                    <label for="phyChemInitialTurbidity">Turbidez Inicial (NTU):</label>
                    <input type="number" id="phyChemInitialTurbidity" placeholder="Ex: 100">
                </div>
                <div class="flex flex-col">
                    <label for="phyChemFinalTurbidity">Turbidez Final (NTU):</label>
                    <input type="number" id="phyChemFinalTurbidity" placeholder="Ex: 5">
                </div>
                <div class="flex flex-col">
                    <label for="phyChemInitialColor">Cor Inicial (UH):</label>
                    <input type="number" id="phyChemInitialColor" placeholder="Ex: 50">
                </div>
                <div class="flex flex-col">
                    <label for="phyChemFinalColor">Cor Final (UH):</label>
                    <input type="number" id="phyChemFinalColor" placeholder="Ex: 2">
                </div>
                <div class="flex flex-col">
                    <label for="phyChemIdealDosage">Dosagem Ideal (Jar Test):</label>
                    <input type="number" id="phyChemIdealDosage" placeholder="Ex: 20">
                </div>
                <div class="flex flex-col">
                    <label for="phyChemDosageUnit">Unidade de Dosagem:</label>
                    <select id="phyChemDosageUnit">
                        <option value="mg/L">mg/L</option>
                        <option value="mL/L">mL/L</option>
                    </select>
                </div>
                <div class="flex flex-col md:col-span-2">
                    <label for="phyChemEtaFlowRate">Vazão da ETA (m³/dia):</label>
                    <input type="number" id="phyChemEtaFlowRate" placeholder="Ex: 5000">
                </div>
            </div>

            <button id="calculatePhysicalChemical" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105">
                Calcular Eficiência Físico-Química
            </button>
            <button
                id="savePhysicalChemicalData"
                class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105"
            >
                Guardar Resultado
            </button>

            <div id="phyChemErrorDisplay" class="mt-6 p-3 bg-red-100 border border-red-400 text-red-700 rounded-md text-center hidden"></div>
            <div id="phyChemResultDisplay" class="mt-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded-md text-center hidden">
                <h4 class="text-lg font-semibold mb-2">Resultados:</h4>
                <div class="flex flex-col gap-2">
                    <div class="flex justify-between items-center bg-white p-3 rounded-md shadow-sm">
                        <strong class="text-gray-700">Eficiência de Remoção (Turbidez):</strong>
                        <span id="phyChemTurbidityEfficiency" class="font-semibold text-green-700">-- %</span>
                    </div>
                    <div class="flex justify-between items-center bg-white p-3 rounded-md shadow-sm">
                        <strong class="text-gray-700">Eficiência de Remoção (Cor):</strong>
                        <span id="phyChemColorEfficiency" class="font-semibold text-green-700">-- %</span>
                    </div>
                    <div class="flex justify-between items-center bg-white p-3 rounded-md shadow-sm">
                        <strong class="text-gray-700">Dosagem Diária (Produto Químico):</strong>
                        <span id="phyChemDailyDosage" class="font-semibold text-green-700">--</span>
                    </div>
                </div>
            </div>
            <div class="mt-8 text-sm text-gray-600 text-center">
                <p>
                    Esta calculadora auxilia na determinação da eficiência de remoção de turbidez e cor,
                    além da dosagem diária de coagulante/floculante necessária para a sua Estação de Tratamento de Água (ETA).
                </p>
                <p class="mt-4 text-xs text-gray-500">
                    Desenvolvido por Diego Machado Sutil
                </p>
            </div>

            <!-- Histórico da Calculadora Eficiência Físico-Química -->
            <div class="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Histórico de Cálculos de Eficiência Físico-Química</h3>
                <div id="physicalChemicalHistory" class="overflow-x-auto">
                    <!-- Histórico será carregado aqui -->
                    <p class="text-center text-gray-500">A carregar histórico...</p>
                </div>
            </div>
        </div>

        <!-- Nova Seção: Cálculo de Carga Orgânica (DBO/DQO) -->
        <div id="organicLoadSection" class="hidden-section">
            <h3 class="text-2xl font-bold text-center text-gray-800 mb-8">
                Cálculo de Carga Orgânica (DBO/DQO)
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="flex flex-col">
                    <label for="organicInfluentConcentration">Concentração Afluente (mg/L DBO ou DQO):</label>
                    <input type="number" id="organicInfluentConcentration" placeholder="Ex: 300">
                </div>
                <div class="flex flex-col">
                    <label for="organicEffluentConcentration">Concentração Efluente (mg/L DBO ou DQO):</label>
                    <input type="number" id="organicEffluentConcentration" placeholder="Ex: 50">
                </div>
                <div class="flex flex-col md:col-span-2">
                    <label for="organicLoadFlowRate">Vazão (m³/dia):</label>
                    <input type="number" id="organicLoadFlowRate" placeholder="Ex: 5000">
                </div>
            </div>

            <button id="calculateOrganicLoadButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105">
                Calcular Carga Orgânica e Eficiência
            </button>
            <button
                id="saveOrganicLoadData"
                class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105"
            >
                Guardar Resultado
            </button>

            <div id="organicLoadErrorDisplay" class="mt-6 p-3 bg-red-100 border border-red-400 text-red-700 rounded-md text-center hidden"></div>
            <div id="organicLoadResultDisplay" class="mt-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded-md text-center hidden">
                <h4 class="text-lg font-semibold mb-2">Resultados:</h4>
                <div class="flex flex-col gap-2">
                    <div class="flex justify-between items-center bg-white p-3 rounded-md shadow-sm">
                        <strong class="text-gray-700">Carga Orgânica Afluente:</strong>
                        <span id="influentOrganicLoadResult" class="font-semibold text-green-700">-- kg/dia</span>
                    </div>
                    <div class="flex justify-between items-center bg-white p-3 rounded-md shadow-sm">
                        <strong class="text-gray-700">Carga Orgânica Efluente:</strong>
                        <span id="effluentOrganicLoadResult" class="font-semibold text-green-700">-- kg/dia</span>
                    </div>
                    <div class="flex justify-between items-center bg-white p-3 rounded-md shadow-sm">
                        <strong class="text-gray-700">Eficiência de Remoção (Carga Orgânica):</strong>
                        <span id="organicLoadEfficiencyResult" class="font-semibold text-green-700">-- %</span>
                    </div>
                </div>
            </div>
            <div class="mt-8 text-sm text-gray-600 text-center">
                <p>
                    Este cálculo determina a carga orgânica diária (DBO ou DQO) que entra e sai da estação,
                    além da eficiência do processo de tratamento na remoção dessa carga.
                </p>
                <p class="mt-2 font-bold">
                    Fórmulas utilizadas:
                </p>
                <p class="mt-1">
                    Carga (kg/dia) = (Concentração (mg/L) &times; Vazão (m³/dia)) / 1000
                </p>
                <p class="mt-1">
                    Eficiência de Remoção (%) = ((Carga Afluente - Carga Efluente) / Carga Afluente) &times; 100
                </p>
                <p class="mt-4 text-xs text-gray-500">
                    Desenvolvido por Diego Machado Sutil
                </p>
            </div>

            <!-- Histórico da Calculadora Carga Orgânica -->
            <div class="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Histórico de Cálculos de Carga Orgânica</h3>
                <div id="organicLoadHistory" class="overflow-x-auto">
                    <!-- Histórico será carregado aqui -->
                    <p class="text-center text-gray-500">A carregar histórico...</p>
                </div>
            </div>
        </div>

        <!-- Nova Seção: Como Funciona -->
        <div id="howItWorksSection" class="hidden-section">
            <h3 class="text-2xl font-bold text-center text-gray-800 mb-8">
                Como Funciona
            </h3>
            <div class="text-base text-gray-700 space-y-4">
                <p class="mb-4">
                    Esta aplicação centraliza três calculadoras essenciais para o controlo operacional de uma Estação de Tratamento de Efluentes (ETE) ou Estação de Tratamento de Águas Residuais (ETAR).
                </p>

                <h4 class="text-xl font-semibold text-gray-800 mb-2">Navegação entre Calculadoras</h4>
                <p class="mb-4">
                    No topo da interface, logo abaixo do título principal, encontrará botões de navegação para cada calculadora e esta seção:
                </p>
                <ul class="list-disc list-inside ml-4 mb-4 space-y-1">
                    <li><strong>Calculadora Idade do Lodo</strong></li>
                    <li><strong>Eficiência Físico-Química</strong></li>
                    <li><strong>Carga Orgânica (DBO/DQO)</strong></li>
                    <li><strong>Como Funciona</strong> (Esta aba!)</li>
                </ul>
                <p class="mb-4">
                    Ao clicar num desses botões, a seção correspondente da calculadora será exibida, enquanto as outras serão ocultadas. O botão da calculadora ativa ficará com um fundo verde escuro e texto branco, facilitando a identificação da seção em uso.
                </p>

                <h4 class="text-xl font-semibold text-gray-800 mb-2">1. Calculadora Idade do Lodo</h4>
                <p>Esta seção permite calcular a Idade do Lodo (ISR), um parâmetro crucial para o controlo de sistemas de lodos ativados.</p>
                <ul class="list-disc list-inside ml-4 space-y-1">
                    <li><strong>Finalidade:</strong> Determina o tempo médio de permanência dos sólidos voláteis no sistema de aeração.</li>
                    <li><strong>Campos de Entrada:</strong>
                        <ul class="list-disc list-inside ml-6 space-y-0.5">
                            <li><strong>Volume do Tanque de Aeração (m³):</strong> O volume total do reator biológico.</li>
                            <li><strong>SSV no Tanque de Aeração (mg/L):</strong> A concentração de Sólidos Suspensos Voláteis dentro do tanque de aeração.</li>
                            <li><strong>Vazão de Descarte (L/min):</strong> A vazão contínua com que o lodo é descartado do sistema.</li>
                            <li><strong>SSV do Lodo Descartado (mg/L):</strong> A concentração de Sólidos Suspensos Voláteis no lodo que é descartado.</li>
                            <li><strong>Vazão do Efluente Final (m³/dia):</strong> A vazão de saída do efluente tratado da estação.</li>
                            <li><strong>SSV do Efluente Final (mg/L):</strong> A concentração de Sólidos Suspensos Voláteis no efluente final.</li>
                        </ul>
                    </li>
                    <li><strong>Funcionalidade de Importação de CSV:</strong>
                        <ul class="list-disc list-inside ml-6 space-y-0.5">
                            <li>Pode arrastar e soltar um ficheiro <code>.csv</code> na área designada ou clicar em "Selecione um ficheiro CSV".</li>
                            <li>Ao clicar em "Analisar CSV e Preencher Campos", a calculadora tentará ler o CSV e preencher automaticamente os campos de SSV.</li>
                            <li><strong>Formato Esperado do CSV:</strong> A calculadora procura por colunas com os cabeçalhos <strong>"Tanque"</strong> e <strong>"Sólidos Voláteis mg/l"</strong>. Ela tentará identificar os valores de SSV com base no conteúdo da coluna "Tanque":
                                <ul class="list-disc list-inside ml-8 space-y-0.5">
                                    <li><code>Tanque de aeração</code> para "SSV no Tanque de Aeração".</li>
                                    <li><code>Reciclo</code> para "SSV do Lodo Descartado".</li>
                                    <li><code>Decantador secundário</code> para "SSV do Efluente Final".</li>
                                </ul>
                            </li>
                            <li><strong>Observação:</strong> A funcionalidade de CSV está em desenvolvimento, portanto, pode haver variações e a necessidade de ajustar o formato do seu ficheiro para que seja lido corretamente (o delimitador esperado é ponto e vírgula <code>;</code> e decimais com vírgula <code>,</code>).</li>
                        </ul>
                    </li>
                    <li><strong>Cálculo:</strong> Ao clicar em "Calcular Idade do Lodo", a aplicação usa as informações fornecidas para calcular:
                        <ul class="list-disc list-inside ml-6 space-y-0.5">
                            <li>Massa de SSV no Tanque (mg) = Volume do Tanque (L) &times; SSV do Tanque (mg/L)</li>
                            <li>Massa de SSV Removida Diariamente (mg/dia) = (Vazão de Descarte (L/dia) &times; SSV Descartado (mg/L)) + (Vazão do Efluente (L/dia) &times; SSV do Efluente (mg/L))</li>
                            <li><strong>ISR (dias) = (Massa de SSV no Tanque de Aeração) / (Massa de SSV Removida Diariamente)</strong></li>
                        </ul>
                    </li>
                    <li><strong>Resultado:</strong> A Idade do Lodo calculada é exibida em "dias".</li>
                </ul>

                <h4 class="text-xl font-semibold text-gray-800 mb-2 mt-6">2. Eficiência Físico-Química</h4>
                <p>Esta seção é baseada na sua calculadora anterior de Jar Test e ajuda a avaliar a eficácia do tratamento físico-químico.</p>
                <ul class="list-disc list-inside ml-4 space-y-1">
                    <li><strong>Finalidade:</strong> Calcula a eficiência de remoção de turbidez e cor, e a dosagem diária de produto químico necessária.</li>
                    <li><strong>Campos de Entrada:</strong>
                        <ul class="list-disc list-inside ml-6 space-y-0.5">
                            <li><strong>Turbidez Inicial (NTU):</strong> Turbidez da água antes do tratamento.</li>
                            <li><strong>Turbidez Final (NTU):</strong> Turbidez da água após o tratamento.</li>
                            <li><strong>Cor Inicial (UH):</strong> Cor da água antes do tratamento.</li>
                            <li><strong>Cor Final (UH):</strong> Cor da água após o tratamento.</li>
                            <li><strong>Dosagem Ideal (Jar Test):</strong> A dosagem de coagulante/floculante determinada em testes de laboratório (com opção de mg/L ou mL/L).</li>
                            <li><strong>Vazão da ETA (m³/dia):</strong> A vazão média da Estação de Tratamento de Água/Efluentes.</li>
                        </ul>
                    </li>
                    <li><strong>Cálculo:</strong> Ao clicar em "Calcular Eficiência Físico-Química", a aplicação calcula:
                        <ul class="list-disc list-inside ml-6 space-y-0.5">
                            <li><strong>Eficiência de Remoção (%) = ((Valor Inicial - Valor Final) / Valor Inicial) &times; 100</strong>
                                <ul class="list-disc list-inside ml-8 space-y-0.5">
                                    <li>Aplicado para Turbidez e Cor.</li>
                                </ul>
                            </li>
                            <li><strong>Dosagem Diária (Produto Químico):</strong> Baseado na dosagem ideal do Jar Test e na vazão da ETA.
                                <ul class="list-disc list-inside ml-8 space-y-0.5">
                                    <li>Se mg/L: (Dosagem Ideal &times; Vazão da ETA) / 1000 (resultado em kg/dia).</li>
                                    <li>Se mL/L: (Dosagem Ideal &times; Vazão da ETA) (resultado em L/dia).</li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li><strong>Resultados:</strong> Exibe a eficiência de remoção para turbidez e cor, e a dosagem diária do produto químico.</li>
                </ul>

                <h4 class="text-xl font-semibold text-gray-800 mb-2 mt-6">3. Carga Orgânica (DBO/DQO)</h4>
                <p>Esta é a seção mais recente, focada na avaliação da carga orgânica que entra e sai da estação.</p>
                <ul class="list-disc list-inside ml-4 space-y-1">
                    <li><strong>Finalidade:</strong> Calcula a carga orgânica afluente e efluente (em kg/dia) e a eficiência de remoção.</li>
                    <li><strong>Campos de Entrada:</strong>
                        <ul class="list-disc list-inside ml-6 space-y-0.5">
                            <li><strong>Concentração Afluente (mg/L DBO ou DQO):</strong> Concentração da matéria orgânica na entrada da ETE/ETAR.</li>
                            <li><strong>Concentração Efluente (mg/L DBO ou DQO):</strong> Concentração da matéria orgânica na saída da ETE/ETAR.</li>
                            <li><strong>Vazão (m³/dia):</strong> A vazão de efluente da estação.</li>
                        </ul>
                    </li>
                    <li><strong>Cálculo:</strong> Ao clicar em "Calcular Carga Orgânica e Eficiência", a aplicação calcula:
                        <ul class="list-disc list-inside ml-6 space-y-0.5">
                            <li><strong>Carga (kg/dia) = (Concentração (mg/L) &times; Vazão (m³/dia)) / 1000</strong>
                                <ul class="list-disc list-inside ml-8 space-y-0.5">
                                    <li>Aplicado para a carga afluente e efluente.</li>
                                </ul>
                            </li>
                            <li><strong>Eficiência de Remoção (%) = ((Carga Afluente - Carga Efluente) / Carga Afluente) &times; 100</strong></li>
                        </ul>
                    </li>
                    <li><strong>Resultados:</strong> Exibe a carga orgânica afluente, a carga orgânica efluente (ambas em kg/dia) e a eficiência de remoção percentual.</li>
                </ul>

                <h4 class="text-xl font-semibold text-gray-800 mb-2 mt-6">Como Usar Geralmente:</h4>
                <ol class="list-decimal list-inside ml-4 space-y-1">
                    <li><strong>Preencha os Campos:</strong> Insira os valores numéricos nos campos de entrada da calculadora que deseja usar.</li>
                    <li><strong>Validação:</strong> A calculadora verificará se os valores são válidos e positivos. Se houver algum erro (ex: campo vazio, valor negativo), uma mensagem de erro será exibida.</li>
                    <li><strong>Calcular:</strong> Clique no botão "Calcular" da respetiva seção para ver os resultados.</li>
                    <li><strong>Guardar Resultado:</strong> Após calcular, clique no botão "Guardar Resultado" para persistir os dados na base de dados.</li>
                    <li><strong>Histórico:</strong> A seção de "Histórico de Cálculos" exibirá os registos guardados, permitindo carregar ou excluir entradas.</li>
                    <li><strong>Limpar:</strong> Os campos são limpos automaticamente ao carregar a página para uma nova análise.</li>
                </ol>
                <p class="mt-4 text-xs text-gray-500 text-center">
                    Desenvolvido por Diego Machado Sutil
                </p>
            </div>
        </div>
    </div>

    <!-- JavaScript embutido -->
    <script type="module">
        // Importações modulares do Firebase SDK (versão 11+)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, deleteDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        
        // --- Configuração Firebase ---
        // A configuração do Firebase será injetada aqui em ambientes de produção.
        // Para desenvolvimento local ou GitHub Pages, usamos valores de fallback.
        const firebaseConfig = typeof window.__firebase_config !== 'undefined'
            ? JSON.parse(window.__firebase_config)
            : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "default-app-id" }; // Configuração de fallback
        
        const appId = firebaseConfig.projectId || 'default-app-id';

        let app;
        let auth;
        let db;
        let currentUserId = null;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, user => {
                if (user) {
                    currentUserId = user.uid;
                    console.log("Utilizador autenticado:", currentUserId);
                } else {
                    signInAnonymously(auth).catch(error => {
                        console.error("Erro na autenticação anónima:", error);
                        currentUserId = 'localUser'; // Fallback
                    });
                }
                document.getElementById('userIdDisplay').textContent = `ID do Utilizador: ${currentUserId}`;
                loadAllHistories();
            });
        } catch (e) {
            console.error("Erro ao inicializar Firebase:", e);
            document.getElementById('userIdDisplay').textContent = "Erro de conexão com a base de dados.";
        }

        // --- Funções Auxiliares ---
        function getResultColorClass(value, type) {
            switch (type) {
                case 'sludgeAge':
                    if (value >= 5 && value <= 15) return 'result-positive';
                    if ((value > 15 && value <= 20) || (value < 5 && value >=0)) return 'result-warning';
                    return 'result-negative';
                case 'efficiency':
                    if (value >= 80) return 'result-positive';
                    if (value >= 60) return 'result-warning';
                    return 'result-negative';
                default:
                    return '';
            }
        }
        
        // --- Funções de Navegação e UI ---
        function showSection(sectionId) {
            ['sludgeAgeSection', 'physicalChemicalSection', 'organicLoadSection', 'howItWorksSection'].forEach(id => {
                document.getElementById(id).classList.add('hidden-section');
            });
            document.getElementById(sectionId).classList.remove('hidden-section');

            const buttons = {
                'sludgeAgeSection': 'showSludgeAge',
                'physicalChemicalSection': 'showPhysicalChemical',
                'organicLoadSection': 'showOrganicLoad',
                'howItWorksSection': 'showHowItWorks'
            };

            Object.values(buttons).forEach(buttonId => {
                const button = document.getElementById(buttonId);
                button.classList.remove('bg-green-600', 'text-white');
                button.classList.add('bg-green-200', 'text-green-800');
            });

            const activeButton = document.getElementById(buttons[sectionId]);
            activeButton.classList.add('bg-green-600', 'text-white');
            activeButton.classList.remove('bg-green-200', 'text-green-800');
        }

        // --- Funções de Cálculo ---
        function calculateSludgeAge() {
            const inputs = {
                aerationTankVolume: parseFloat(document.getElementById('aerationTankVolume').value),
                aerationTankVSS: parseFloat(document.getElementById('aerationTankVSS').value),
                discardFlowRate: parseFloat(document.getElementById('discardFlowRate').value),
                discardVSS: parseFloat(document.getElementById('discardVSS').value),
                effluentFlowRate: parseFloat(document.getElementById('effluentFlowRate').value),
                effluentVSS: parseFloat(document.getElementById('effluentVSS').value),
            };

            const errorDisplay = document.getElementById('errorDisplay');
            const resultDisplay = document.getElementById('resultDisplay');
            errorDisplay.classList.add('hidden');
            resultDisplay.classList.add('hidden');

            if (Object.values(inputs).some(isNaN) || Object.values(inputs).some(v => v < 0)) {
                errorDisplay.textContent = 'Por favor, preencha todos os campos com valores numéricos positivos válidos.';
                errorDisplay.classList.remove('hidden');
                return null;
            }

            const totalVSSMassAerationTank = inputs.aerationTankVolume * 1000 * inputs.aerationTankVSS;
            const totalVSSMassDiscardedDaily = inputs.discardFlowRate * 1440 * inputs.discardVSS;
            const totalVSSMassInEffluentDaily = inputs.effluentFlowRate * 1000 * inputs.effluentVSS;
            const denominator = totalVSSMassDiscardedDaily + totalVSSMassInEffluentDaily;

            if (denominator === 0) {
                errorDisplay.textContent = 'A soma das massas de SSV descartadas e no efluente é zero. Verifique os valores de entrada.';
                errorDisplay.classList.remove('hidden');
                return null;
            }

            const calculatedISR = totalVSSMassAerationTank / denominator;
            const resultSpan = document.getElementById('sludgeAgeResult');
            resultSpan.textContent = `${calculatedISR.toFixed(2)} dias`;
            resultSpan.className = `text-2xl font-bold mt-2 ${getResultColorClass(calculatedISR, 'sludgeAge')}`;
            resultDisplay.classList.remove('hidden');

            return { ...inputs, calculatedISR };
        }

        function calculatePhysicalChemicalEfficiency() {
            const inputs = {
                initialTurbidity: parseFloat(document.getElementById('phyChemInitialTurbidity').value),
                finalTurbidity: parseFloat(document.getElementById('phyChemFinalTurbidity').value),
                initialColor: parseFloat(document.getElementById('phyChemInitialColor').value),
                finalColor: parseFloat(document.getElementById('phyChemFinalColor').value),
                idealDosage: parseFloat(document.getElementById('phyChemIdealDosage').value),
                etaFlowRate: parseFloat(document.getElementById('phyChemEtaFlowRate').value),
                dosageUnit: document.getElementById('phyChemDosageUnit').value,
            };
            
            const errorDisplay = document.getElementById('phyChemErrorDisplay');
            const resultDisplay = document.getElementById('phyChemResultDisplay');
            errorDisplay.classList.add('hidden');

            if (Object.values(inputs).slice(0,6).some(isNaN) || Object.values(inputs).slice(0,6).some(v => v < 0)) {
                errorDisplay.textContent = 'Por favor, preencha todos os campos com valores numéricos válidos e não negativos.';
                errorDisplay.classList.remove('hidden');
                return null;
            }
            
            const turbidityEfficiency = inputs.initialTurbidity > 0 ? ((inputs.initialTurbidity - inputs.finalTurbidity) / inputs.initialTurbidity) * 100 : (inputs.finalTurbidity === 0 ? 100 : 0);
            const colorEfficiency = inputs.initialColor > 0 ? ((inputs.initialColor - inputs.finalColor) / inputs.initialColor) * 100 : (inputs.finalColor === 0 ? 100 : 0);

            let dailyDosage, dailyDosageUnit;
            if (inputs.dosageUnit === 'mg/L') {
                dailyDosage = (inputs.idealDosage * inputs.etaFlowRate) / 1000;
                dailyDosageUnit = 'kg/dia';
            } else {
                dailyDosage = inputs.idealDosage * inputs.etaFlowRate;
                dailyDosageUnit = 'L/dia';
            }

            document.getElementById('phyChemTurbidityEfficiency').textContent = `${turbidityEfficiency.toFixed(2)} %`;
            document.getElementById('phyChemTurbidityEfficiency').className = `font-semibold ${getResultColorClass(turbidityEfficiency, 'efficiency')}`;
            document.getElementById('phyChemColorEfficiency').textContent = `${colorEfficiency.toFixed(2)} %`;
            document.getElementById('phyChemColorEfficiency').className = `font-semibold ${getResultColorClass(colorEfficiency, 'efficiency')}`;
            document.getElementById('phyChemDailyDosage').textContent = `${dailyDosage.toFixed(2)} ${dailyDosageUnit}`;
            resultDisplay.classList.remove('hidden');
            
            return { ...inputs, turbidityEfficiency, colorEfficiency, dailyDosage, dailyDosageUnit };
        }

        function calculateOrganicLoad() {
             const inputs = {
                influentConcentration: parseFloat(document.getElementById('organicInfluentConcentration').value),
                effluentConcentration: parseFloat(document.getElementById('organicEffluentConcentration').value),
                flowRate: parseFloat(document.getElementById('organicLoadFlowRate').value),
            };

            const errorDisplay = document.getElementById('organicLoadErrorDisplay');
            const resultDisplay = document.getElementById('organicLoadResultDisplay');
            errorDisplay.classList.add('hidden');

            if (Object.values(inputs).some(isNaN) || Object.values(inputs).some(v => v < 0)) {
                errorDisplay.textContent = 'Por favor, preencha todos os campos com valores numéricos válidos e não negativos.';
                errorDisplay.classList.remove('hidden');
                return null;
            }
            
            const influentLoad = (inputs.influentConcentration * inputs.flowRate) / 1000;
            const effluentLoad = (inputs.effluentConcentration * inputs.flowRate) / 1000;
            const efficiency = influentLoad > 0 ? ((influentLoad - effluentLoad) / influentLoad) * 100 : (effluentLoad === 0 ? 100 : 0);
            
            document.getElementById('influentOrganicLoadResult').textContent = `${influentLoad.toFixed(2)} kg/dia`;
            document.getElementById('effluentOrganicLoadResult').textContent = `${effluentLoad.toFixed(2)} kg/dia`;
            document.getElementById('organicLoadEfficiencyResult').textContent = `${efficiency.toFixed(2)} %`;
            document.getElementById('organicLoadEfficiencyResult').className = `font-semibold ${getResultColorClass(efficiency, 'efficiency')}`;
            resultDisplay.classList.remove('hidden');
            
            return { ...inputs, influentLoad, effluentLoad, efficiency };
        }
        
        // --- Funções de Dados (Firestore) ---
        async function saveData(collectionName, data) {
            if (!db || !currentUserId) {
                alert("Conexão com a base de dados não disponível. Não foi possível guardar os dados.");
                return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/${collectionName}`), {
                    ...data,
                    timestamp: new Date()
                });
                console.log("Dados guardados com sucesso!");
            } catch (e) {
                console.error("Erro ao guardar documento: ", e);
                alert("Ocorreu um erro ao guardar os dados.");
            }
        }
        
        function setupHistoryListener(collectionName, displayElementId, columns, rowRenderer, loadFunction) {
            if (!db || !currentUserId) return;
            const q = query(collection(db, `artifacts/${appId}/users/${currentUserId}/${collectionName}`), orderBy("timestamp", "desc"));

            onSnapshot(q, (snapshot) => {
                const historyData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayHistory(displayElementId, historyData, columns, rowRenderer, loadFunction, collectionName);
            });
        }
        
        function displayHistory(displayElementId, data, columns, rowRenderer, loadFunction, collectionName) {
            const displayElement = document.getElementById(displayElementId);
            if (!displayElement) return;

            if (data.length === 0) {
                displayElement.innerHTML = `<p class="text-center text-gray-500">Nenhum cálculo guardado ainda.</p>`;
                return;
            }
            
            let tableHtml = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                            ${columns.map(col => `<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${col}</th>`).join('')}
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${data.map(entry => rowRenderer(entry)).join('')}
                    </tbody>
                </table>`;

            displayElement.innerHTML = tableHtml;

            displayElement.querySelectorAll('.load-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const entryToLoad = data.find(item => item.id === e.target.dataset.id);
                    if (entryToLoad) loadFunction(entryToLoad);
                });
            });

            displayElement.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    if (confirm('Tem a certeza que deseja excluir este registo?')) {
                        await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/${collectionName}`, e.target.dataset.id));
                    }
                });
            });
        }

        function loadAllHistories() {
            // Sludge Age History
            setupHistoryListener('sludgeAgeCalculations', 'sludgeAgeHistory', ['ISR (dias)'],
                (entry) => `
                    <tr class="hover:bg-gray-100">
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${new Date(entry.timestamp.toDate()).toLocaleString()}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${entry.calculatedISR.toFixed(2)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-right text-sm font-medium flex gap-2">
                            <button data-id="${entry.id}" class="text-indigo-600 hover:text-indigo-900 load-btn">Carregar</button>
                            <button data-id="${entry.id}" class="text-red-600 hover:text-red-900 delete-btn">Excluir</button>
                        </td>
                    </tr>`,
                (entry) => {
                    document.getElementById('aerationTankVolume').value = entry.aerationTankVolume;
                    document.getElementById('aerationTankVSS').value = entry.aerationTankVSS;
                    document.getElementById('discardFlowRate').value = entry.discardFlowRate;
                    document.getElementById('discardVSS').value = entry.discardVSS;
                    document.getElementById('effluentFlowRate').value = entry.effluentFlowRate;
                    document.getElementById('effluentVSS').value = entry.effluentVSS;
                    calculateSludgeAge();
                }
            );

            // Physical Chemical History
            setupHistoryListener('physicalChemicalCalculations', 'physicalChemicalHistory', ['Eficiência Turb. (%)', 'Eficiência Cor (%)'],
                (entry) => `
                     <tr class="hover:bg-gray-100">
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${new Date(entry.timestamp.toDate()).toLocaleString()}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${entry.turbidityEfficiency.toFixed(2)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${entry.colorEfficiency.toFixed(2)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-right text-sm font-medium flex gap-2">
                            <button data-id="${entry.id}" class="text-indigo-600 hover:text-indigo-900 load-btn">Carregar</button>
                            <button data-id="${entry.id}" class="text-red-600 hover:text-red-900 delete-btn">Excluir</button>
                        </td>
                    </tr>`,
                (entry) => {
                    document.getElementById('phyChemInitialTurbidity').value = entry.initialTurbidity;
                    document.getElementById('phyChemFinalTurbidity').value = entry.finalTurbidity;
                    document.getElementById('phyChemInitialColor').value = entry.initialColor;
                    document.getElementById('phyChemFinalColor').value = entry.finalColor;
                    document.getElementById('phyChemIdealDosage').value = entry.idealDosage;
                    document.getElementById('phyChemEtaFlowRate').value = entry.etaFlowRate;
                    document.getElementById('phyChemDosageUnit').value = entry.dosageUnit;
                    calculatePhysicalChemicalEfficiency();
                }
            );
            
            // Organic Load History
             setupHistoryListener('organicLoadCalculations', 'organicLoadHistory', ['Carga Afluente (kg/dia)', 'Eficiência (%)'],
                (entry) => `
                     <tr class="hover:bg-gray-100">
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${new Date(entry.timestamp.toDate()).toLocaleString()}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${entry.influentLoad.toFixed(2)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${entry.efficiency.toFixed(2)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-right text-sm font-medium flex gap-2">
                            <button data-id="${entry.id}" class="text-indigo-600 hover:text-indigo-900 load-btn">Carregar</button>
                            <button data-id="${entry.id}" class="text-red-600 hover:text-red-900 delete-btn">Excluir</button>
                        </td>
                    </tr>`,
                (entry) => {
                    document.getElementById('organicInfluentConcentration').value = entry.influentConcentration;
                    document.getElementById('organicEffluentConcentration').value = entry.effluentConcentration;
                    document.getElementById('organicLoadFlowRate').value = entry.flowRate;
                    calculateOrganicLoad();
                }
            );
        }

        // --- CSV Parsing ---
        function parseCSVAndFillFields(file) {
            const reader = new FileReader();
            const statusDisplay = document.getElementById('csvAnalysisStatus');
            reader.onload = (event) => {
                const text = event.target.result;
                const lines = text.split(/\r\n|\n/).filter(line => line);
                if (lines.length < 2) {
                    statusDisplay.textContent = 'Ficheiro CSV inválido ou vazio.';
                    return;
                }
                const headers = lines[0].split(';').map(h => h.trim());
                const data = lines.slice(1).map(line => {
                    const values = line.split(';');
                    return headers.reduce((obj, header, i) => {
                        obj[header] = values[i] ? values[i].trim() : '';
                        return obj;
                    }, {});
                });
                
                const vssAeration = data.filter(r => r['Tanque'] && r['Tanque'].toLowerCase().includes('aeração')).map(r => parseFloat(r['Sólidos Voláteis mg/l'].replace(',', '.')));
                const vssDiscard = data.filter(r => r['Tanque'] && r['Tanque'].toLowerCase().includes('reciclo')).map(r => parseFloat(r['Sólidos Voláteis mg/l'].replace(',', '.')));
                const vssEffluent = data.filter(r => r['Tanque'] && r['Tanque'].toLowerCase().includes('decantador secundário')).map(r => parseFloat(r['Sólidos Voláteis mg/l'].replace(',', '.')));
                
                if (vssAeration.length) document.getElementById('aerationTankVSS').value = (vssAeration.reduce((a,b)=>a+b,0)/vssAeration.length).toFixed(2);
                if (vssDiscard.length) document.getElementById('discardVSS').value = (vssDiscard.reduce((a,b)=>a+b,0)/vssDiscard.length).toFixed(2);
                if (vssEffluent.length) document.getElementById('effluentVSS').value = vssEffluent[0].toFixed(2);
                
                statusDisplay.textContent = 'Dados do CSV preenchidos.';
            };
            reader.onerror = () => statusDisplay.textContent = 'Erro ao ler o ficheiro.';
            reader.readAsText(file);
        }

        // --- Event Listeners ---
        document.getElementById('showSludgeAge').addEventListener('click', () => showSection('sludgeAgeSection'));
        document.getElementById('showPhysicalChemical').addEventListener('click', () => showSection('physicalChemicalSection'));
        document.getElementById('showOrganicLoad').addEventListener('click', () => showSection('organicLoadSection'));
        document.getElementById('showHowItWorks').addEventListener('click', () => showSection('howItWorksSection'));

        document.getElementById('calculateButton').addEventListener('click', calculateSludgeAge);
        document.getElementById('saveSludgeAgeData').addEventListener('click', () => {
            const data = calculateSludgeAge();
            if(data) saveData('sludgeAgeCalculations', data);
        });

        document.getElementById('calculatePhysicalChemical').addEventListener('click', calculatePhysicalChemicalEfficiency);
        document.getElementById('savePhysicalChemicalData').addEventListener('click', () => {
            const data = calculatePhysicalChemicalEfficiency();
            if(data) saveData('physicalChemicalCalculations', data);
        });

        document.getElementById('calculateOrganicLoadButton').addEventListener('click', calculateOrganicLoad);
        document.getElementById('saveOrganicLoadData').addEventListener('click', () => {
            const data = calculateOrganicLoad();
            if(data) saveData('organicLoadCalculations', data);
        });

        const csvFileInput = document.getElementById('csvFile');
        document.getElementById('analyzeCsvButton').addEventListener('click', () => {
            if (csvFileInput.files.length > 0) parseCSVAndFillFields(csvFileInput.files[0]);
        });
        const csvDropZone = document.getElementById('csvDropZone');
        csvDropZone.addEventListener('dragover', (e) => { e.preventDefault(); csvDropZone.classList.add('drag-over'); });
        csvDropZone.addEventListener('dragleave', () => csvDropZone.classList.remove('drag-over'));
        csvDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            csvDropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) {
                csvFileInput.files = e.dataTransfer.files;
                parseCSVAndFillFields(csvFileInput.files[0]);
            }
        });

        // Initial state
        showSection('sludgeAgeSection');
    </script>
</body>
</html>
