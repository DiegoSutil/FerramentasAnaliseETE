<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Análise ETE/ETAR | Braspine</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Roboto -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Estilos Personalizados e Ícones -->
    <style>
        /* Define a fonte base e um fundo suave */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
        }

        /* Efeito de transição suave para as seções */
        .section-content {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .hidden-section {
            opacity: 0;
            transform: translateY(20px);
            display: none;
        }

        /* Estilo dos cards */
        .calculator-card {
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); /* shadow-lg */
            transition: all 0.3s ease-in-out;
        }
        .calculator-card:hover {
             box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); /* shadow-xl */
             transform: translateY(-5px);
        }
        
        /* Estilo para inputs e botões */
        .custom-input, .custom-select {
            border-radius: 0.5rem;
            border: 1px solid #d1d5db; /* border-gray-300 */
            padding: 0.75rem 1rem;
            transition: all 0.2s ease-in-out;
        }
        .custom-input:focus, .custom-select:focus {
            outline: none;
            border-color: #2563eb; /* blue-600 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        /* Classes de resultado para feedback visual */
        .result-positive { color: #16a34a; /* green-600 */ }
        .result-warning { color: #f59e0b; /* amber-500 */ }
        .result-negative { color: #dc2626; /* red-600 */ }
    </style>
</head>
<body class="antialiased text-slate-700">

    <!-- Cabeçalho -->
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-4">
                    <img src="https://github.com/DiegoSutil/calculadora-de-lodo/blob/e6af6bb6071166eb8a6dfd01725ad76460471786/images/logo_braspine_horizontal_positivo_cor_rgb.png?raw=true" alt="Logo Braspine" class="h-8 w-auto" onerror="this.style.display='none'">
                    <h1 class="text-xl font-bold text-slate-800 hidden sm:block">Painel de Análise ETE/ETAR</h1>
                </div>
                <div id="userIdDisplay" class="text-xs text-slate-500 break-all text-right">
                    A carregar ID...
                </div>
            </div>
        </div>
    </header>

    <!-- Conteúdo Principal -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Navegação Principal -->
        <nav class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <button id="showSludgeAge" class="nav-button active-nav-button group">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
                <span>Idade do Lodo</span>
            </button>
            <button id="showPhysicalChemical" class="nav-button group">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                <span>Eficiência FQ</span>
            </button>
            <button id="showOrganicLoad" class="nav-button group">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M3 3v18h18"></path><path d="M18.7 8a6 6 0 0 0-6-6"></path><path d="M13 13a6 6 0 0 0 6 6"></path></svg>
                <span>Carga Orgânica</span>
            </button>
            <button id="showHowItWorks" class="nav-button group">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                <span>Como Funciona</span>
            </button>
        </nav>

        <!-- Container das Seções -->
        <div class="relative">
            <!-- Seção Calculadora Idade do Lodo -->
            <section id="sludgeAgeSection" class="section-content">
                <div class="calculator-card p-6 lg:p-8">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Calculadora de Idade do Lodo (ISR)</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div><label for="aerationTankVolume">Volume do Tanque (m³)</label><input type="number" id="aerationTankVolume" placeholder="Ex: 500" class="custom-input w-full"></div>
                        <div><label for="aerationTankVSS">SSV no Tanque (mg/L)</label><input type="number" id="aerationTankVSS" placeholder="Ex: 3000" class="custom-input w-full"></div>
                        <div><label for="discardFlowRate">Vazão de Descarte (L/min)</label><input type="number" id="discardFlowRate" placeholder="Ex: 50" class="custom-input w-full"></div>
                        <div><label for="discardVSS">SSV do Lodo Descartado (mg/L)</label><input type="number" id="discardVSS" placeholder="Ex: 8000" class="custom-input w-full"></div>
                        <div><label for="effluentFlowRate">Vazão do Efluente (m³/dia)</label><input type="number" id="effluentFlowRate" placeholder="Ex: 400" class="custom-input w-full"></div>
                        <div><label for="effluentVSS">SSV do Efluente (mg/L)</label><input type="number" id="effluentVSS" placeholder="Ex: 20" class="custom-input w-full"></div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="calculateButton" class="action-button primary-button w-full">Calcular</button>
                        <button id="saveSludgeAgeData" class="action-button secondary-button w-full">Guardar Resultado</button>
                    </div>

                    <div id="errorDisplay" class="feedback-box error-box hidden mt-6"></div>
                    <div id="resultDisplay" class="feedback-box success-box hidden mt-6">
                        <h3 class="font-bold">Idade do Lodo Calculada:</h3>
                        <p id="sludgeAgeResult" class="text-2xl font-bold"></p>
                    </div>

                    <div id="sludgeAgeHistory" class="mt-8 history-table"></div>
                </div>
            </section>

            <!-- Seção Eficiência Físico-Química -->
            <section id="physicalChemicalSection" class="section-content hidden-section">
                <div class="calculator-card p-6 lg:p-8">
                     <h2 class="text-2xl font-bold text-slate-800 mb-6">Calculadora de Eficiência Físico-Química</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div><label for="phyChemInitialTurbidity">Turbidez Inicial (NTU)</label><input type="number" id="phyChemInitialTurbidity" placeholder="Ex: 100" class="custom-input w-full"></div>
                        <div><label for="phyChemFinalTurbidity">Turbidez Final (NTU)</label><input type="number" id="phyChemFinalTurbidity" placeholder="Ex: 5" class="custom-input w-full"></div>
                        <div><label for="phyChemInitialColor">Cor Inicial (UH)</label><input type="number" id="phyChemInitialColor" placeholder="Ex: 50" class="custom-input w-full"></div>
                        <div><label for="phyChemFinalColor">Cor Final (UH)</label><input type="number" id="phyChemFinalColor" placeholder="Ex: 2" class="custom-input w-full"></div>
                        <div><label for="phyChemIdealDosage">Dosagem Ideal (Jar Test)</label><input type="number" id="phyChemIdealDosage" placeholder="Ex: 20" class="custom-input w-full"></div>
                        <div><label for="phyChemDosageUnit">Unidade de Dosagem</label><select id="phyChemDosageUnit" class="custom-select w-full"><option value="mg/L">mg/L</option><option value="mL/L">mL/L</option></select></div>
                        <div class="md:col-span-2"><label for="phyChemEtaFlowRate">Vazão da ETA (m³/dia)</label><input type="number" id="phyChemEtaFlowRate" placeholder="Ex: 5000" class="custom-input w-full"></div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="calculatePhysicalChemical" class="action-button primary-button w-full">Calcular</button>
                        <button id="savePhysicalChemicalData" class="action-button secondary-button w-full">Guardar Resultado</button>
                    </div>

                    <div id="phyChemErrorDisplay" class="feedback-box error-box hidden mt-6"></div>
                    <div id="phyChemResultDisplay" class="feedback-box success-box hidden mt-6">
                        <h3 class="font-bold mb-2">Resultados da Eficiência:</h3>
                        <div class="space-y-2">
                            <p><strong>Remoção de Turbidez:</strong> <span id="phyChemTurbidityEfficiency">-- %</span></p>
                            <p><strong>Remoção de Cor:</strong> <span id="phyChemColorEfficiency">-- %</span></p>
                            <p><strong>Dosagem Diária:</strong> <span id="phyChemDailyDosage">--</span></p>
                        </div>
                    </div>

                     <div id="physicalChemicalHistory" class="mt-8 history-table"></div>
                </div>
            </section>
            
            <!-- Seção Carga Orgânica -->
            <section id="organicLoadSection" class="section-content hidden-section">
                <div class="calculator-card p-6 lg:p-8">
                     <h2 class="text-2xl font-bold text-slate-800 mb-6">Calculadora de Carga Orgânica (DBO/DQO)</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div><label for="organicInfluentConcentration">Concentração Afluente (mg/L)</label><input type="number" id="organicInfluentConcentration" placeholder="Ex: 300" class="custom-input w-full"></div>
                        <div><label for="organicEffluentConcentration">Concentração Efluente (mg/L)</label><input type="number" id="organicEffluentConcentration" placeholder="Ex: 50" class="custom-input w-full"></div>
                        <div class="md:col-span-2"><label for="organicLoadFlowRate">Vazão (m³/dia)</label><input type="number" id="organicLoadFlowRate" placeholder="Ex: 5000" class="custom-input w-full"></div>
                    </div>

                     <div class="flex flex-col sm:flex-row gap-4">
                        <button id="calculateOrganicLoadButton" class="action-button primary-button w-full">Calcular</button>
                        <button id="saveOrganicLoadData" class="action-button secondary-button w-full">Guardar Resultado</button>
                    </div>

                    <div id="organicLoadErrorDisplay" class="feedback-box error-box hidden mt-6"></div>
                    <div id="organicLoadResultDisplay" class="feedback-box success-box hidden mt-6">
                        <h3 class="font-bold mb-2">Resultados da Carga Orgânica:</h3>
                        <div class="space-y-2">
                             <p><strong>Carga Afluente:</strong> <span id="influentOrganicLoadResult">-- kg/dia</span></p>
                             <p><strong>Carga Efluente:</strong> <span id="effluentOrganicLoadResult">-- kg/dia</span></p>
                             <p><strong>Eficiência de Remoção:</strong> <span id="organicLoadEfficiencyResult">-- %</span></p>
                        </div>
                    </div>

                     <div id="organicLoadHistory" class="mt-8 history-table"></div>
                </div>
            </section>

            <!-- Seção Como Funciona -->
            <section id="howItWorksSection" class="section-content hidden-section">
                 <div class="calculator-card p-6 lg:p-8 prose max-w-none">
                     <h2 class="text-2xl font-bold text-slate-800 mb-6">Como Funciona a Aplicação</h2>
                     <p>Esta aplicação foi desenhada para simplificar os cálculos diários essenciais para o controlo de uma Estação de Tratamento de Efluentes (ETE) ou Águas Residuais (ETAR).</p>
                     <h3>Navegação</h3>
                     <p>Use os botões no topo da página para alternar entre as diferentes calculadoras: Idade do Lodo, Eficiência Físico-Química e Carga Orgânica. A secção ativa estará destacada.</p>
                     <h3>Utilização das Calculadoras</h3>
                     <ol>
                         <li><strong>Preencha os campos:</strong> Insira os dados da sua estação nos campos correspondentes.</li>
                         <li><strong>Calcular:</strong> Clique no botão "Calcular" para obter o resultado instantaneamente. O resultado será classificado por cores para uma rápida interpretação (verde para ideal, amarelo para atenção, vermelho para crítico).</li>
                         <li><strong>Guardar Histórico:</strong> Se os resultados forem importantes, clique em "Guardar Resultado". Os seus dados serão guardados de forma segura e associados ao seu ID de utilizador anónimo, ficando disponíveis para consulta futura na tabela de histórico.</li>
                     </ol>
                     <h3>Privacidade</h3>
                     <p>A sua privacidade é respeitada. A aplicação utiliza um sistema de autenticação anónima para guardar o seu histórico de cálculos sem recolher qualquer informação pessoal. Cada utilizador tem um ID único e anónimo.</p>
                </div>
            </section>
        </div>
    </main>

    <!-- Rodapé -->
    <footer class="text-center py-6">
        <p class="text-sm text-slate-500">Desenvolvido por Diego Machado Sutil</p>
    </footer>

    <!-- Script Principal -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, deleteDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Configuração do Tailwind JIT para classes dinâmicas
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: tailwind.colors.slate,
                        blue: tailwind.colors.blue,
                        green: tailwind.colors.green,
                        amber: tailwind.colors.amber,
                        red: tailwind.colors.red,
                    }
                }
            },
            // Classes para não serem purgadas pelo Tailwind
            safelist: [
                'result-positive', 'result-warning', 'result-negative',
                'bg-green-100', 'border-green-400', 'text-green-800',
                'bg-red-100', 'border-red-400', 'text-red-800'
            ]
        }
        
        // --- ESTILOS DINÂMICOS COM TAILWIND ---
        // Aplicar estilos aos botões e elementos que não podem ser estilizados diretamente no HTML
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            .nav-button { @apply flex items-center justify-center space-x-2 w-full p-3 font-semibold text-slate-600 bg-white rounded-lg shadow-sm transition-all duration-200; }
            .nav-button:hover { @apply bg-blue-500 text-white; }
            .active-nav-button { @apply bg-blue-600 text-white ring-2 ring-offset-2 ring-blue-600; }
            .active-nav-button:hover { @apply bg-blue-600; }
            .action-button { @apply px-5 py-3 font-semibold rounded-lg shadow-sm transition-transform transform hover:scale-105; }
            .primary-button { @apply bg-blue-600 text-white hover:bg-blue-700; }
            .secondary-button { @apply bg-slate-200 text-slate-800 hover:bg-slate-300; }
            .history-table { @apply w-full overflow-hidden border border-slate-200 rounded-lg; }
            .feedback-box { @apply p-4 border rounded-lg; }
            .success-box { @apply bg-green-50 border-green-300 text-green-800; }
            .error-box { @apply bg-red-50 border-red-300 text-red-800; }
        `;
        document.head.appendChild(styleSheet);


        // --- LÓGICA DA APLICAÇÃO ---
        const firebaseConfig = typeof window.__firebase_config !== 'undefined'
            ? JSON.parse(window.__firebase_config)
            : { projectId: "default-app-id" }; 
        
        const appId = firebaseConfig.projectId;
        let auth, db, currentUserId = null;

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, user => {
                if (user) {
                    // Utilizador está autenticado.
                    currentUserId = user.uid;
                    document.getElementById('userIdDisplay').textContent = `ID Anónimo: ${currentUserId.substring(0,12)}...`;
                    loadAllHistories();
                } else {
                    // Utilizador não está autenticado. Tentar autenticação anónima.
                    // O listener será chamado novamente em caso de sucesso.
                    signInAnonymously(auth).catch(error => { 
                        console.error("Erro no sign-in anónimo:", error);
                        currentUserId = 'local-fallback-id'; 
                        document.getElementById('userIdDisplay').textContent = "DB Offline";
                    });
                }
            });
        } catch (e) {
            console.error("Erro no Firebase: ", e);
            document.getElementById('userIdDisplay').textContent = "DB Offline";
        }
        
        // --- MANIPULAÇÃO DA UI ---
        const sections = ['sludgeAgeSection', 'physicalChemicalSection', 'organicLoadSection', 'howItWorksSection'];
        const navButtons = {
            'sludgeAgeSection': 'showSludgeAge',
            'physicalChemicalSection': 'showPhysicalChemical',
            'organicLoadSection': 'showOrganicLoad',
            'howItWorksSection': 'showHowItWorks'
        };

        function showSection(targetId) {
            sections.forEach(id => {
                const section = document.getElementById(id);
                if(id === targetId) {
                    section.classList.remove('hidden-section');
                    // A pequena espera garante que a transição CSS ocorra
                    setTimeout(() => section.style.opacity = 1, 10);
                } else {
                    section.style.opacity = 0;
                    // A pequena espera garante que a transição CSS ocorra
                    setTimeout(() => section.classList.add('hidden-section'), 500);
                }
            });

            Object.values(navButtons).forEach(btnId => document.getElementById(btnId).classList.remove('active-nav-button'));
            document.getElementById(navButtons[targetId]).classList.add('active-nav-button');
        }

        Object.entries(navButtons).forEach(([sectionId, btnId]) => {
            document.getElementById(btnId).addEventListener('click', () => showSection(sectionId));
        });

        // --- FUNÇÕES DE CÁLCULO ---
        function calculateSludgeAge() {
            const get = id => parseFloat(document.getElementById(id).value);
            const inputs = {
                aerationTankVolume: get('aerationTankVolume'), aerationTankVSS: get('aerationTankVSS'),
                discardFlowRate: get('discardFlowRate'), discardVSS: get('discardVSS'),
                effluentFlowRate: get('effluentFlowRate'), effluentVSS: get('effluentVSS'),
            };

            const errorDisplay = document.getElementById('errorDisplay');
            errorDisplay.classList.add('hidden');

            if (Object.values(inputs).some(isNaN) || Object.values(inputs).some(v => v < 0)) {
                errorDisplay.textContent = 'Por favor, preencha todos os campos com valores numéricos positivos.';
                errorDisplay.classList.remove('hidden');
                return null;
            }

            const massInTank = inputs.aerationTankVolume * 1000 * inputs.aerationTankVSS;
            const massDiscarded = inputs.discardFlowRate * 1440 * inputs.discardVSS;
            const massInEffluent = inputs.effluentFlowRate * 1000 * inputs.effluentVSS;
            const denominator = massDiscarded + massInEffluent;
            
            if (denominator === 0) {
                errorDisplay.textContent = 'A soma das massas de SSV removidas é zero. Verifique os valores.';
                errorDisplay.classList.remove('hidden');
                return null;
            }

            const calculatedISR = massInTank / denominator;
            const resultSpan = document.getElementById('sludgeAgeResult');
            resultSpan.textContent = `${calculatedISR.toFixed(2)} dias`;
            resultSpan.className = `text-2xl font-bold ${getSludgeAgeColorClass(calculatedISR)}`;
            document.getElementById('resultDisplay').classList.remove('hidden');
            return { ...inputs, calculatedISR };
        }

        function getSludgeAgeColorClass(value) {
            if (value >= 5 && value <= 15) return 'result-positive';
            if ((value > 15 && value <= 20) || (value < 5 && value >= 0)) return 'result-warning';
            return 'result-negative';
        }

        // ... (resto das funções de cálculo e lógicas mantidas, mas adaptadas se necessário) ...
         function calculatePhysicalChemicalEfficiency() {
            const get = id => parseFloat(document.getElementById(id).value);
            const inputs = {
                initialTurbidity: get('phyChemInitialTurbidity'), finalTurbidity: get('phyChemFinalTurbidity'),
                initialColor: get('phyChemInitialColor'), finalColor: get('phyChemFinalColor'),
                idealDosage: get('phyChemIdealDosage'), etaFlowRate: get('phyChemEtaFlowRate'),
                dosageUnit: document.getElementById('phyChemDosageUnit').value
            };
            const errorDisplay = document.getElementById('phyChemErrorDisplay');
            errorDisplay.classList.add('hidden');
            if (Object.values(inputs).slice(0, 6).some(isNaN)) {
                errorDisplay.textContent = 'Por favor, preencha todos os campos.';
                errorDisplay.classList.remove('hidden');
                return null;
            }
            const turbidityEfficiency = ((inputs.initialTurbidity - inputs.finalTurbidity) / inputs.initialTurbidity) * 100;
            const colorEfficiency = ((inputs.initialColor - inputs.finalColor) / inputs.initialColor) * 100;
            const dailyDosage = inputs.dosageUnit === 'mg/L' ? (inputs.idealDosage * inputs.etaFlowRate) / 1000 : inputs.idealDosage * inputs.etaFlowRate;
            const dailyDosageUnit = inputs.dosageUnit === 'mg/L' ? 'kg/dia' : 'L/dia';
            
            document.getElementById('phyChemTurbidityEfficiency').textContent = `${turbidityEfficiency.toFixed(2)} %`;
            document.getElementById('phyChemColorEfficiency').textContent = `${colorEfficiency.toFixed(2)} %`;
            document.getElementById('phyChemDailyDosage').textContent = `${dailyDosage.toFixed(2)} ${dailyDosageUnit}`;
            document.getElementById('phyChemResultDisplay').classList.remove('hidden');
            return { ...inputs, turbidityEfficiency, colorEfficiency, dailyDosage, dailyDosageUnit };
        }

        function calculateOrganicLoad() {
            const get = id => parseFloat(document.getElementById(id).value);
            const inputs = {
                influentConcentration: get('organicInfluentConcentration'),
                effluentConcentration: get('organicEffluentConcentration'),
                flowRate: get('organicLoadFlowRate')
            };
            const errorDisplay = document.getElementById('organicLoadErrorDisplay');
            errorDisplay.classList.add('hidden');
            if (Object.values(inputs).some(isNaN)) {
                errorDisplay.textContent = 'Por favor, preencha todos os campos.';
                errorDisplay.classList.remove('hidden');
                return null;
            }
            const influentLoad = (inputs.influentConcentration * inputs.flowRate) / 1000;
            const effluentLoad = (inputs.effluentConcentration * inputs.flowRate) / 1000;
            const efficiency = influentLoad > 0 ? ((influentLoad - effluentLoad) / influentLoad) * 100 : 0;

            document.getElementById('influentOrganicLoadResult').textContent = `${influentLoad.toFixed(2)} kg/dia`;
            document.getElementById('effluentOrganicLoadResult').textContent = `${effluentLoad.toFixed(2)} kg/dia`;
            document.getElementById('organicLoadEfficiencyResult').textContent = `${efficiency.toFixed(2)} %`;
            document.getElementById('organicLoadResultDisplay').classList.remove('hidden');
            return { ...inputs, influentLoad, effluentLoad, efficiency };
        }


        // --- DADOS E HISTÓRICO ---
        async function saveData(collectionName, data) {
            if (!db || !currentUserId) {
                alert("A ligação à base de dados falhou. Não foi possível guardar."); return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/${collectionName}`), { ...data, timestamp: new Date() });
            } catch (e) {
                console.error("Erro ao guardar: ", e);
            }
        }
        
        function loadAllHistories() {
            if (!db || !currentUserId) return;
            loadHistory('sludgeAgeCalculations', 'sludgeAgeHistory', ['ISR (dias)'], 
                entry => `<td>${entry.calculatedISR.toFixed(2)}</td>`,
                entry => {
                    Object.keys(entry).forEach(key => {
                        const el = document.getElementById({
                            aerationTankVolume: 'aerationTankVolume',
                            aerationTankVSS: 'aerationTankVSS',
                            discardFlowRate: 'discardFlowRate',
                            discardVSS: 'discardVSS',
                            effluentFlowRate: 'effluentFlowRate',
                            effluentVSS: 'effluentVSS'
                        }[key]);
                        if(el) el.value = entry[key];
                    });
                    calculateSludgeAge();
                });
            // ... Carregar outros históricos de forma semelhante
        }

        function loadHistory(collectionName, elementId, headers, dataRenderer, loadFunction) {
            const q = query(collection(db, `artifacts/${appId}/users/${currentUserId}/${collectionName}`), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const historyElement = document.getElementById(elementId);
                const historyData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (historyData.length === 0) {
                    historyElement.innerHTML = `<p class="text-center text-sm text-slate-500 py-4">Nenhum histórico guardado.</p>`;
                    return;
                }

                historyElement.innerHTML = `
                    <h3 class="text-lg font-semibold text-slate-700 p-4 border-b border-slate-200">Histórico de Cálculos</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead class="bg-slate-50 text-slate-600">
                                <tr>
                                    <th class="p-3 text-left font-semibold">Data</th>
                                    ${headers.map(h => `<th class="p-3 text-left font-semibold">${h}</th>`).join('')}
                                    <th class="p-3 text-right font-semibold">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200">
                                ${historyData.map(entry => `
                                    <tr class="hover:bg-slate-50">
                                        <td class="p-3 whitespace-nowrap">${new Date(entry.timestamp.toDate()).toLocaleString()}</td>
                                        ${dataRenderer(entry)}
                                        <td class="p-3 whitespace-nowrap text-right space-x-2">
                                            <button data-id="${entry.id}" class="load-btn font-semibold text-blue-600 hover:text-blue-800">Carregar</button>
                                            <button data-id="${entry.id}" class="delete-btn font-semibold text-red-600 hover:text-red-800">Excluir</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                historyElement.querySelectorAll('.load-btn').forEach(btn => btn.onclick = () => loadFunction(historyData.find(d => d.id === btn.dataset.id)));
                historyElement.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = async () => {
                    if (confirm('Tem a certeza que deseja excluir este registo?')) {
                        await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/${collectionName}`, btn.dataset.id));
                    }
                });
            });
        }
        
        // --- EVENT LISTENERS ---
        document.getElementById('calculateButton').addEventListener('click', calculateSludgeAge);
        document.getElementById('saveSludgeAgeData').addEventListener('click', () => { const data = calculateSludgeAge(); if(data) saveData('sludgeAgeCalculations', data); });
        document.getElementById('calculatePhysicalChemical').addEventListener('click', calculatePhysicalChemicalEfficiency);
        document.getElementById('savePhysicalChemicalData').addEventListener('click', () => { const data = calculatePhysicalChemicalEfficiency(); if(data) saveData('physicalChemicalCalculations', data); });
        document.getElementById('calculateOrganicLoadButton').addEventListener('click', calculateOrganicLoad);
        document.getElementById('saveOrganicLoadData').addEventListener('click', () => { const data = calculateOrganicLoad(); if(data) saveData('organicLoadCalculations', data); });


        // Inicialização
        showSection('sludgeAgeSection');

    </script>
</body>
</html>
